<?php
/*
 *  Copyright 2022.  Baks.dev <admin@baks.dev>
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *   limitations under the License.
 *
 */

namespace BaksDev\Wildberries\Repository\AllShopSettingsToken;

use App\Module\User\AuthEmail\Account\Entity as AccountEntity;
use App\Module\User\AuthEmail\Account\Type\Status\AccountStatus;
use App\Module\User\AuthEmail\Account\Type\Status\AccountStatusEnum;
use App\Module\User\Profile\UserProfile\Entity as EntityUserProfile;
use App\Module\User\Profile\UserProfile\Type\Id\UserProfileUid;
use App\Module\User\Profile\UserProfile\Type\Status\UserProfileStatus;
use App\Module\User\Profile\UserProfile\Type\Status\UserProfileStatusEnum;
use App\Module\Wildberries\Settings\Entity;
use Doctrine\ORM\EntityManagerInterface;

final class AllShopSettingsTokenRepository implements AllShopSettingsTokenInterface
{
    private EntityManagerInterface $entityManager;
    private UserProfileStatus $status;
    private AccountStatus $account_status;
    
    public function __construct(EntityManagerInterface $entityManager)
    {
        $this->entityManager = $entityManager;
        $this->status = new UserProfileStatus(UserProfileStatusEnum::ACTIVE);
        $this->account_status = new AccountStatus(AccountStatusEnum::ACTIVE);
    }
    
    public function get() : mixed
    {
        $qb = $this->entityManager->createQueryBuilder();
        
        $select = sprintf('new %s(event.settings, event.token, event.cookie, event.identifier)', UserProfileUid::class);
        
        $qb->select($select);
        
        $qb->from(Entity\Settings::class, 'settings');
        
        $qb->join(
          Entity\Event\Event::class,
          'event',
          'WITH',
          'event.id = settings.event AND
          event.settings = settings.id AND
          event.active = true');
        
        $qb->join(EntityUserProfile\UserProfile::class, 'users_profile', 'WITH', 'users_profile.id = event.settings');
        $qb->join(
          EntityUserProfile\Info\Info::class,
          'users_profile_info',
          'WITH',
          'users_profile_info.profile = users_profile.id AND users_profile_info.status = :status');
        
        /* Аккаунт пользователя */

        $qb->join(
          AccountEntity\Account::class,
          'account',
          'WITH',
          'account.id = users_profile_info.user');
        
        $qb->join(
          AccountEntity\Status\Status::class,
          'status',
          'WITH',
          'status.event = account.event AND status.status = :account_status');
        
        $qb->setParameter('account_status', $this->account_status, AccountStatus::TYPE);
        
        $qb->setParameter('status', $this->status, UserProfileStatus::TYPE);
        
        return $qb->getQuery()->getResult();
    }
	
	
	
    
}